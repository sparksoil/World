<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ron ‚Äî Pet Job Income Ledger</title>
<style>
  :root{
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    /* Ron palette: cedar / stone / moss with good contrast */
    --ink: #1f2937;         /* slate-800 */
    --stone: #f5f5f4;       /* stone-100 */
    --grain: #e7e5e4;       /* stone-200 */
    --line: #d6d3d1;        /* stone-300 */
    --cedar: #374151;       /* slate-700 (buttons) */
    --moss: #365a3c;        /* deep green accent */
    --success-bg:#e7f5ec;   /* quiet success */
    --success-bd:#b6e2c7;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --ink:#e5e7eb; --stone:#0b0f14; --grain:#11151a; --line:#25313b; --cedar:#1f2937; --moss:#90c59e;
      --success-bg:#0f1a14; --success-bd:#1b3b28;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--stone); color:var(--ink); font-family:var(--font); line-height:1.45;
    /* subtle woodgrain */
    background-image: linear-gradient(var(--stone),var(--stone)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><path d="M0 70c30-25 60-25 90 0s60 25 90 0" fill="none" stroke="%23d6d3d1" stroke-opacity=".12" stroke-width="2"/></svg>');
    background-blend-mode: multiply;
  }
  .wrap{max-width:980px; margin:24px auto; padding:0 16px}
  .card{
    background:#fff0; border:1px solid var(--line); border-radius:14px; padding:16px;
    backdrop-filter:saturate(110%);
  }
  h1{margin:0 0 6px; font-size:1.25rem; font-weight:650}
  h2{margin:0 0 8px; font-size:1.05rem; font-weight:650}
  p.muted{margin:0 0 10px; color:#6b7280; font-size:.93rem}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .row-4{display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:12px}
  @media (max-width:760px){ .row,.row-3,.row-4{grid-template-columns:1fr} }
  label{display:grid; gap:6px; font-size:.95rem}
  input,select,textarea,button{
    font:inherit; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff;
    color:var(--ink);
  }
  input[type="date"]{padding:8px 10px}
  textarea{min-height:70px; resize:vertical}
  button.primary{background:var(--cedar); color:#fff; border:none; border-radius:12px; padding:12px 16px; cursor:pointer}
  button.secondary{background:var(--grain)}
  .actions{display:flex; gap:10px}
  .divider{height:1px; background:repeating-linear-gradient(90deg,var(--line),var(--line) 8px,transparent 8px,transparent 16px); margin:16px 0}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:var(--grain); font-size:.85rem}
  .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .right{text-align:right}
  .success{background:var(--success-bg); color:var(--moss); border:1px solid var(--success-bd); padding:8px 10px; border-radius:10px; display:none}
  .bar{height:8px; border-radius:6px; background:var(--grain); overflow:hidden}
  .fill{height:100%; background:var(--moss)}
  table{width:100%; border-collapse:collapse; background:#fff}
  th,td{padding:8px 10px; border-bottom:1px solid var(--line); text-align:left; font-size:.95rem}
  tfoot td{font-weight:600; border-top:2px solid var(--line)}
  details.settings{margin:8px 0 0}
  details.settings summary{cursor:pointer; user-select:none}
  /* Lucy Mode: calmer layout */
  .lucy body, .lucy .wrap{letter-spacing:.2px}
  .lucy .inline .pill{display:none}
  .lucy .bar{display:none}
  .lucy .actions{gap:6px}
  .lucy table th:nth-child(5), .lucy table td:nth-child(5){ /* Amount column stays */
  }
  .lucy .muted{color:#5b6470}
  .quietline{border:none; height:1px; background:var(--line); opacity:.6; margin:6px 0 12px}
  .footer{margin-top:10px; font-size:.9rem; color:#6b7280}
  .toggle{display:flex; align-items:center; gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="region" aria-label="Ron Ledger">
    <div class="inline" style="justify-content:space-between">
      <div>
        <h1>Ron ‚Äî Pet Job Income Ledger</h1>
        <p class="muted">Straight lines. Quiet totals. Set aside what needs setting aside.</p>
      </div>
      <label class="toggle" title="Reduce visual noise for Lucy">
        <input id="lucyToggle" type="checkbox"> Lucy Mode
      </label>
    </div>

    <!-- Settings -->
    <details class="settings">
      <summary><strong>Settings</strong> ‚Äî Set-Aside % (Ron‚Äôs Jar)</summary>
      <div class="row" style="margin-top:8px;">
        <label>Set-Aside Percentage (% to reserve)
          <input id="reservePct" type="number" step="0.1" min="0" max="100" placeholder="25">
        </label>
        <div class="inline" style="align-items:flex-end;">
          <button id="saveSettings" type="button" class="secondary">Save</button>
          <span class="muted">Used to compute ‚ÄúSet-Aside‚Äù and ‚ÄúNet‚Äù. Defaults to 25%.</span>
        </div>
      </div>
    </details>

    <hr class="quietline">

    <!-- Form -->
    <form id="entryForm" aria-describedby="savedMsg">
      <div class="row">
        <label>Date
          <input type="date" name="date" required>
        </label>
        <label>Client
          <input name="client" placeholder="Keely / Dexter / Witcher" required>
        </label>
      </div>

      <div class="row-3">
        <label>Service
          <input name="service" placeholder="Drop-in / Overnight / Litter clean" required>
        </label>
        <label>Amount (USD)
          <input type="number" step="0.01" name="amount" min="0" required placeholder="45.00">
        </label>
        <label>Payment Method
          <select name="method" required>
            <option value="Cash">Cash</option>
            <option value="Venmo">Venmo</option>
            <option value="Zelle">Zelle</option>
            <option value="Card">Card</option>
            <option value="Other">Other</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label class="inline"><input type="checkbox" name="paid"> Mark as paid</label>
        <label>Field Log
          <input name="notes" placeholder="Council remarks, special care, etc.">
        </label>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="primary" type="submit" aria-label="Save entry">Log to Ledger</button>
        <button class="secondary" type="button" id="clearBtn" aria-label="Clear form">Wipe Slate</button>
      </div>
      <p id="savedMsg" class="success" role="status" aria-live="polite">Logged. Ron set it on the shelf. ü™µ</p>
    </form>

    <div class="divider" aria-hidden="true"></div>

    <!-- Summaries -->
    <div class="row">
      <div>
        <h2>This Season‚Äôs Stack</h2>
        <div class="inline">
          <span class="pill" id="monthLabel">Month</span>
          <span class="pill">Logs: <span id="countMonth">0</span></span>
          <span class="pill">Gross: $<span id="grossMonth">0.00</span></span>
          <span class="pill">Set-Aside: $<span id="reserveMonth">0.00</span></span>
          <span class="pill">Net: $<span id="netMonth">0.00</span></span>
          <span class="pill">Paid: $<span id="paidMonth">0.00</span></span>
          <span class="pill">Unpaid: $<span id="unpaidMonth">0.00</span></span>
        </div>
        <div class="bar" style="margin-top:10px;" aria-hidden="true"><div class="fill" id="paidBar" style="width:0%"></div></div>
      </div>
      <div class="right">
        <h2>The Mountain‚Äôs Record</h2>
        <div>Logs: <strong id="countAll">0</strong></div>
        <div>Gross: <strong>$<span id="totalAll">0.00</span></strong></div>
        <div>Set-Aside: <strong>$<span id="reserveAll">0.00</span></strong></div>
        <div>Net: <strong>$<span id="netAll">0.00</span></strong></div>
      </div>
    </div>

    <!-- Table -->
    <div class="card" style="margin-top:10px; padding:10px;">
      <div class="inline" style="justify-content:space-between; margin-bottom:6px;">
        <strong>Ledger</strong>
        <small class="muted">The mountain remembers.</small>
      </div>
      <div class="grid">
        <table aria-label="Logged entries">
          <thead>
            <tr>
              <th>Date</th><th>Client</th><th>Service</th><th>Method</th>
              <th class="right">Amount</th>
              <th class="right">Set-Aside</th>
              <th class="right">Net</th>
              <th>Paid</th><th>Field Log</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
          <tfoot>
            <tr>
              <td colspan="4">Totals</td>
              <td class="right">$<span id="totalFoot">0.00</span></td>
              <td class="right">$<span id="totalReserveFoot">0.00</span></td>
              <td class="right">$<span id="totalNetFoot">0.00</span></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="footer">Emits <code>sparksoil-income-created</code> to the parent (for your Swirl). Set-Aside defaults to 25% unless changed.</div>
  </div>
</div>

<script>
(() => {
  // ---------- Keys ----------
  const KEY = 'sparksoil_income_entries_v1';
  const SETTINGS_KEY = 'sparksoil_income_settings_v1';
  const LUCY_KEY = 'sparksoil_income_lucy_v1';

  // ---------- Storage ----------
  const Storage = {
    load(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] } },
    save(entries){ localStorage.setItem(KEY, JSON.stringify(entries)) }
  };
  const Settings = {
    load(){ const def={reservePct:25}; try{ return {...def, ...(JSON.parse(localStorage.getItem(SETTINGS_KEY))||{})} }catch{ return def } },
    save(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)) }
  };

  // Optional outbound (Google Apps Script webhook later)
  const OutboundAdapter = {
    webhookUrl: null,
    async send(entry){
      if(!this.webhookUrl) return {ok:true, skipped:true};
      try{
        const res = await fetch(this.webhookUrl,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(entry), mode:'cors'});
        return {ok:res.ok};
      }catch(e){ console.warn('OutboundAdapter failed',e); return {ok:false, error:e}; }
    }
  };

  // ---------- DOM ----------
  const $ = s=>document.querySelector(s);
  const form = $('#entryForm');
  const rows = $('#rows');
  const savedMsg = $('#savedMsg');

  const reservePctInput = $('#reservePct');
  const saveSettingsBtn = $('#saveSettings');
  const lucyToggle = $('#lucyToggle');

  const monthLabel = $('#monthLabel');
  const countMonth = $('#countMonth');
  const grossMonth = $('#grossMonth');
  const reserveMonth = $('#reserveMonth');
  const netMonth = $('#netMonth');
  const paidMonth = $('#paidMonth');
  const unpaidMonth = $('#unpaidMonth');
  const paidBar = $('#paidBar');

  const countAll = $('#countAll');
  const totalAll = $('#totalAll');
  const reserveAll = $('#reserveAll');
  const netAll = $('#netAll');

  const totalFoot = $('#totalFoot');
  const totalReserveFoot = $('#totalReserveFoot');
  const totalNetFoot = $('#totalNetFoot');

  const fmtMoney = n => (Number(n||0)).toFixed(2);
  const todayISO = () => new Date().toISOString().slice(0,10);
  form.date.value = todayISO();

  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

  // ---------- State ----------
  let entries = Storage.load().map(e=>({...e, amount:Number(e.amount)||0, paid:!!e.paid}));
  let settings = Settings.load();

  // Settings UI
  reservePctInput.value = settings.reservePct;
  saveSettingsBtn.addEventListener('click', ()=> {
    const pct = Number(reservePctInput.value);
    settings.reservePct = isNaN(pct)||pct<0 ? 0 : Math.min(100,pct);
    Settings.save(settings);
    render();
  });

  // Lucy mode (persisted)
  (function initLucy(){
    const on = localStorage.getItem(LUCY_KEY)==='1';
    lucyToggle.checked = on;
    document.documentElement.classList.toggle('lucy', on);
    lucyToggle.addEventListener('change', ()=>{
      const val = lucyToggle.checked;
      document.documentElement.classList.toggle('lucy', val);
      localStorage.setItem(LUCY_KEY, val ? '1' : '0');
    });
  })();

  // ---------- Helpers ----------
  const monthKey = d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`;
  const currentMonthKey = () => monthKey(new Date());
  const calcReserve = amt => (amt * (settings.reservePct/100));
  const calcNet = amt => (amt - calcReserve(amt));

  // ---------- Render ----------
  function render(){
    rows.innerHTML = entries.map(e=>{
      const reserve = calcReserve(e.amount);
      const net = e.amount - reserve;
      return `<tr>
        <td>${e.date}</td>
        <td>${escapeHtml(e.client)}</td>
        <td>${escapeHtml(e.service)}</td>
        <td>${escapeHtml(e.method)}</td>
        <td class="right">${e.amount.toFixed(2)}</td>
        <td class="right">${reserve.toFixed(2)}</td>
        <td class="right">${net.toFixed(2)}</td>
        <td>${e.paid ? 'Yes' : 'No'}</td>
        <td>${escapeHtml(e.notes||'')}</td>
      </tr>`;
    }).join('');

    // All-time
    const grossAll = entries.reduce((s,e)=>s+e.amount,0);
    const reserveAllVal = entries.reduce((s,e)=>s+calcReserve(e.amount),0);
    const netAllVal = grossAll - reserveAllVal;

    countAll.textContent = entries.length;
    totalAll.textContent = fmtMoney(grossAll);
    reserveAll.textContent = fmtMoney(reserveAllVal);
    netAll.textContent = fmtMoney(netAllVal);

    totalFoot.textContent = fmtMoney(grossAll);
    totalReserveFoot.textContent = fmtMoney(reserveAllVal);
    totalNetFoot.textContent = fmtMoney(netAllVal);

    // Month
    const cmk = currentMonthKey();
    const monthEntries = entries.filter(e=> (e.date||'').slice(0,7) === cmk);
    const grossM = monthEntries.reduce((s,e)=>s+e.amount,0);
    const reserveM = monthEntries.reduce((s,e)=>s+calcReserve(e.amount),0);
    const netM = grossM - reserveM;
    const paidM = monthEntries.filter(e=>e.paid).reduce((s,e)=>s+e.amount,0);
    const unpaidM = grossM - paidM;

    monthLabel.textContent = new Date().toLocaleString(undefined,{month:'long', year:'numeric'});
    countMonth.textContent = monthEntries.length;
    grossMonth.textContent = fmtMoney(grossM);
    reserveMonth.textContent = fmtMoney(reserveM);
    netMonth.textContent = fmtMoney(netM);
    paidMonth.textContent = fmtMoney(paidM);
    unpaidMonth.textContent = fmtMoney(unpaidM);

    const pctPaid = grossM>0 ? Math.max(0,Math.min(100,(paidM/grossM)*100)) : 0;
    paidBar.style.width = pctPaid.toFixed(0)+'%';
  }

  // Submit
  form.addEventListener('submit', async ev=>{
    ev.preventDefault();
    const fd = new FormData(form);
    const entry = {
      id: crypto.randomUUID(),
      date: fd.get('date') || todayISO(),
      client: (fd.get('client')||'').trim(),
      service: (fd.get('service')||'').trim(),
      amount: Number(fd.get('amount')||0),
      method: fd.get('method') || 'Other',
      paid: !!fd.get('paid'),
      notes: (fd.get('notes')||'').trim(),
      reservePct: settings.reservePct,
    };
    entry.reserve = Number((entry.amount * (settings.reservePct/100)).toFixed(2));
    entry.net = Number((entry.amount - entry.reserve).toFixed(2));

    // Basic validation
    if(!entry.date){ alert('The shelf won‚Äôt hold unless you fill the date.'); return; }
    if(!entry.client){ alert('Name the client so the log can stand.'); return; }

    entries.push(entry);
    Storage.save(entries);
    render();

    // Bridge to Swirl
    try{ window.parent?.postMessage({ type:'sparksoil-income-created', payload:entry }, '*'); }catch{}

    // Optional outbound webhook
    await OutboundAdapter.send(entry);

    savedMsg.style.display='block';
    setTimeout(()=> savedMsg.style.display='none', 1400);
    form.reset();
    form.date.value = todayISO();
  });

  // Clear
  $('#clearBtn').addEventListener('click', ()=> form.reset());

  // Initial render
  render();
})();
</script>
</body>
</html>
